steps:
  - task: CondaEnvironment@1
    inputs:
      environmentName: 'test_environment'
      updateConda: false
      packageSpecs: 'python=$(python.version) pip nose'
      installOptions: '-c conda-forge'
      createOptions: '-c conda-forge'
      cleanEnvironment: true
      createCustomEnvironment: true

  - bash: |
      - if [ $(use_master) == 'false' ]; then
          conda install --quiet --yes brian2
        else
          pip install https://github.com/brian-team/brian2/archive/master.zip
        fi

  - script: python -m pip install --no-deps --ignore-installed --user .
    displayName: 'Install Brian2GeNN'

  - bash: |
      git clone --depth=1 https://github.com/genn-team/genn.git ../genn
      cd ../genn
      if [ $(use_master) == 'false' ]; then
        git fetch --tags
        git checkout $(genn_stable)
      fi
    displayName: 'Install GeNN'

  - task: CopyFiles@2
    inputs:
      sourceFolder: $(Build.SourcesDirectory)/continuous-integration/
      contents: 'brian_preferences'
      targetFolder: $(Build.SourcesDirectory)/..

  - bash: |
      export GENN_PATH=$(python -c "import os; print(os.path.realpath('../genn'))")
      SOURCE_PATH=$(pwd)
      cd ..  # move out of the source directory to avoid direct import
      python $SOURCE_PATH/scripts/$(script_name)
    displayName: 'Run tests'
